pipeline {
    agent any

    environment {
        SECRET_NAME   = 'my-secret'
        NAMESPACE     = 'my-namespace'
        PSC_DB_SECRET = 'my-secret-value'
    }

    stages {
        stage('Patch Secret') {
            steps {
                sh '''
                  set -euo pipefail

                  patch_secret() {
                    local SECRET_NAME="$1"
                    local NAMESPACE="$2"
                    local PSC_DB_SECRET="$3"

                    echo "Patching Secret '$SECRET_NAME' in namespace '$NAMESPACE'..."

                    SECRET_PAYLOAD=$(jq -nc --arg name "$(echo -n "$PSC_DB_SECRET" | base64)" '{data: {commonNameDB: $name}}')

                    if kubectl patch secret "$SECRET_NAME" \
                        -n "$NAMESPACE" \
                        --type=merge \
                        -p "$SECRET_PAYLOAD"
                    then
                      echo "commonNameDB set to '${PSC_DB_SECRET}' (base64-encoded)"
                    else
                      echo "Failed to patch Secret" >&2
                      exit 2
                    fi
                  }

                  patch_secret "$SECRET_NAME" "$NAMESPACE" "$PSC_DB_SECRET"
                '''
            }
        }
    }
}
